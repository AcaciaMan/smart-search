<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Search Refinement</title>
<style>
  :root {
    --border: var(--vscode-panel-border, #444);
    --bg: var(--vscode-editor-background, #1e1e1e);
    --bg2: var(--vscode-sideBar-background, #252526);
    --fg: var(--vscode-editor-foreground, #ccc);
    --accent: var(--vscode-focusBorder, #007fd4);
    --btn-bg: var(--vscode-button-background, #0e639c);
    --btn-fg: var(--vscode-button-foreground, #fff);
    --btn-hover: var(--vscode-button-hoverBackground, #1177bb);
    --input-bg: var(--vscode-input-background, #3c3c3c);
    --input-fg: var(--vscode-input-foreground, #ccc);
    --input-border: var(--vscode-input-border, #555);
    --chip-bg: var(--vscode-badge-background, #4d4d4d);
    --chip-fg: var(--vscode-badge-foreground, #fff);
    --chip-inc: #1a4f1a;
    --chip-exc: #4f1a1a;
    --chip-custom-border: 1px dashed var(--accent);
    --separator: var(--vscode-panel-border, #3a3a3a);
    --tree-hover: var(--vscode-list-hoverBackground, #2a2d2e);
    --neutral-btn: var(--vscode-descriptionForeground, #888);
    --inc-btn: #3a7c3a;
    --exc-btn: #7c3a3a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--vscode-font-family, 'Segoe UI', sans-serif);
    font-size: var(--vscode-font-size, 13px);
    color: var(--fg);
    background: var(--bg);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── Main layout ── */
  .layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    grid-template-rows: 1fr;
    gap: 0;
    flex: 1;
    overflow: hidden;
  }

  /* ── Left pane ── */
  .left-pane {
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .pane-title {
    padding: 8px 12px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: var(--vscode-sideBarTitle-foreground, #bbb);
    border-bottom: 1px solid var(--separator);
    flex-shrink: 0;
  }

  .tree-section-label {
    padding: 6px 12px 2px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--vscode-descriptionForeground, #888);
  }

  .tree-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
  }

  .tree-row {
    display: flex;
    align-items: center;
    padding: 3px 12px;
    cursor: default;
    gap: 8px;
  }
  .tree-row:hover { background: var(--tree-hover); }

  .tree-label {
    flex: 1;
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .tristate {
    display: flex;
    border-radius: 3px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .tristate button {
    border: none;
    cursor: pointer;
    font-size: 10px;
    padding: 2px 5px;
    background: var(--input-bg);
    color: var(--neutral-btn);
    transition: background .15s;
  }
  .tristate button:hover { filter: brightness(1.3); }
  .tristate button.active-inc { background: var(--inc-btn); color: #90ee90; }
  .tristate button.active-exc { background: var(--exc-btn); color: #ee9090; }

  /* ── Right pane ── */
  .right-pane {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    gap: 0;
  }

  .right-section {
    padding: 10px 14px;
    border-bottom: 1px solid var(--separator);
    flex-shrink: 0;
  }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--vscode-descriptionForeground, #888);
    margin-bottom: 6px;
  }

  /* ── Chip rows ── */
  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    min-height: 24px;
    align-items: center;
  }

  .chip-row-label {
    font-size: 11px;
    opacity: .7;
    margin-right: 2px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 7px;
    border-radius: 10px;
    font-size: 11px;
    font-family: var(--vscode-editor-font-family, monospace);
  }
  .chip.inc { background: var(--chip-inc); color: #90ee90; }
  .chip.exc { background: var(--chip-exc); color: #ee9090; }
  .chip.custom { border: var(--chip-custom-border); }
  .chip .chip-x {
    cursor: pointer;
    opacity: .7;
    font-size: 12px;
    line-height: 1;
    padding: 0 1px;
  }
  .chip .chip-x:hover { opacity: 1; }

  /* ── Custom globs ── */
  .custom-globs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .custom-group label {
    display: block;
    font-size: 11px;
    opacity: .75;
    margin-bottom: 4px;
  }

  textarea {
    width: 100%;
    height: 60px;
    resize: vertical;
    background: var(--input-bg);
    color: var(--input-fg);
    border: 1px solid var(--input-border);
    border-radius: 3px;
    padding: 5px 7px;
    font-family: var(--vscode-editor-font-family, monospace);
    font-size: 12px;
    line-height: 1.5;
  }
  textarea:focus { outline: 1px solid var(--accent); border-color: var(--accent); }

  /* ── Preview ── */
  .preview-section {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .effective-list {
    display: flex;
    flex-direction: column;
    gap: 3px;
    max-height: 100px;
    overflow-y: auto;
  }

  .effective-item {
    font-family: var(--vscode-editor-font-family, monospace);
    font-size: 12px;
  }
  .effective-item.inc { color: #90ee90; }
  .effective-item.exc { color: #ee9090; }

  pre.rg-preview {
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 3px;
    padding: 7px 10px;
    font-size: 11px;
    font-family: var(--vscode-editor-font-family, monospace);
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 90px;
    overflow-y: auto;
    color: var(--input-fg);
  }

  .preview-empty {
    font-size: 12px;
    opacity: .5;
    font-style: italic;
  }

  /* ── Action buttons ── */
  .action-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 10px 14px;
    border-top: 1px solid var(--separator);
    flex-shrink: 0;
  }

  button.primary {
    background: var(--btn-bg);
    color: var(--btn-fg);
    border: none;
    border-radius: 3px;
    padding: 6px 14px;
    cursor: pointer;
    font-size: 12px;
  }
  button.primary:hover { background: var(--btn-hover); }

  button.secondary {
    background: transparent;
    color: var(--fg);
    border: 1px solid var(--input-border);
    border-radius: 3px;
    padding: 5px 13px;
    cursor: pointer;
    font-size: 12px;
  }
  button.secondary:hover { background: var(--tree-hover); }

  .empty-tree {
    padding: 12px;
    font-size: 12px;
    opacity: .5;
    font-style: italic;
  }

  /* ── Test result banner ── */
  .test-banner {
    display: none;
    margin: 8px 14px 0;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 12px;
    line-height: 1.5;
  }
  .test-banner.success {
    background: #1a3a1a;
    border: 1px solid #3a7c3a;
    color: #90ee90;
  }
  .test-banner.error {
    background: #3a1a1a;
    border: 1px solid #7c3a3a;
    color: #ee9090;
  }
  .test-banner .banner-title {
    font-weight: 600;
    margin-bottom: 4px;
  }
  .test-banner .sample-list {
    max-height: 110px;
    overflow-y: auto;
    margin-top: 6px;
    padding-left: 14px;
  }
  .test-banner .sample-list li {
    font-family: var(--vscode-editor-font-family, monospace);
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    list-style: disc;
  }
  textarea.ta-error {
    border-color: #cc5555 !important;
    outline: 1px solid #cc5555 !important;
  }
  .ta-error-hint {
    font-size: 11px;
    color: #ee9090;
    margin-top: 3px;
    display: none;
  }
  .ta-error-hint.visible { display: block; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--vscode-scrollbarSlider-background, #555); border-radius: 3px; }
</style>
</head>
<body>

<!-- ─── Layout ──────────────────────────────────────────────────── -->
<div class="layout">

  <!-- LEFT: File/Extension tree -->
  <div class="left-pane">
    <div class="pane-title">Workspace Tree</div>
    <div class="tree-list" id="treeList">
      <div class="empty-tree">Loading…</div>
    </div>
  </div>

  <!-- RIGHT: Chips + Custom globs + Preview + Actions -->
  <div class="right-pane">

    <!-- Chip rows -->
    <div class="right-section">
      <div class="section-label">Include globs</div>
      <div class="chip-row" id="incChips"></div>
    </div>

    <div class="right-section">
      <div class="section-label">Exclude globs</div>
      <div class="chip-row" id="excChips"></div>
    </div>

    <!-- Custom globs -->
    <div class="right-section">
      <div class="section-label">Custom globs</div>
      <div class="custom-globs">
        <div class="custom-group">
          <label for="customIncTA">Custom includes (comma or newline)</label>
          <textarea id="customIncTA" placeholder="**/mydir/**&#10;**/*.json"></textarea>
          <div class="ta-error-hint" id="customIncHint"></div>
        </div>
        <div class="custom-group">
          <label for="customExcTA">Custom excludes (comma or newline)</label>
          <textarea id="customExcTA" placeholder="**/node_modules/**&#10;**/dist/**"></textarea>
          <div class="ta-error-hint" id="customExcHint"></div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="preview-section">
      <div class="section-label">Effective globs preview</div>
      <div class="effective-list" id="effectiveList">
        <div class="preview-empty">No globs active.</div>
      </div>

      <div class="section-label" style="margin-top:8px;">Ripgrep flags preview</div>
      <pre class="rg-preview" id="rgPreview"></pre>
    </div>

    <!-- Actions -->
    <div class="action-bar">
      <button class="primary" id="btnApply">Apply &amp; Re-run</button>
      <button class="secondary" id="btnSave">Save as filter…</button>
      <button class="secondary" id="btnTest">Test globs with ripgrep</button>
    </div>

    <!-- Test result banner -->
    <div class="test-banner" id="testBanner">
      <div class="banner-title" id="testBannerTitle"></div>
      <div id="testBannerBody"></div>
    </div>
  </div>
</div>

<script>
(function () {
  /* ── VS Code API ─────────────────────────── */
  const vscode = acquireVsCodeApi();

  /* ── State ───────────────────────────────── */
  let state = {
    includeGlobs:       [],
    excludeGlobs:       [],
    customIncludeGlobs: [],
    customExcludeGlobs: [],
  };

  // Map: glob pattern → { kind: 'inc'|'exc', source: 'tree'|'chip' }
  // Used to track what patterns came from which tree node (folder/ext).
  const nodeGlobMap = new Map(); // nodeId → { incGlob, excGlob }

  /* ── Helpers ─────────────────────────────── */
  function dedupe(arr) {
    const seen = new Set();
    return arr.filter(x => { if (seen.has(x)) return false; seen.add(x); return true; });
  }

  function parseTextarea(val) {
    return val.split(/[,\n]/).map(s => s.trim()).filter(Boolean);
  }

  function joinTextarea(arr) {
    return arr.join('\n');
  }

  function postState() {
    vscode.postMessage({ type: 'stateChanged', ...state });
  }

  /* ── Effective / preview calculation ─────── */
  function computeEffective() {
    return {
      includes: dedupe([...state.includeGlobs, ...state.customIncludeGlobs]),
      excludes: dedupe([...state.excludeGlobs, ...state.customExcludeGlobs]),
    };
  }

  function renderPreview() {
    const { includes, excludes } = computeEffective();
    const list = document.getElementById('effectiveList');
    if (includes.length === 0 && excludes.length === 0) {
      list.innerHTML = '<div class="preview-empty">No globs active.</div>';
    } else {
      list.innerHTML = [
        ...includes.map(g => `<div class="effective-item inc">+ ${escHtml(g)}</div>`),
        ...excludes.map(g => `<div class="effective-item exc">- ${escHtml(g)}</div>`),
      ].join('');
    }
    const rgParts = [
      ...includes.map(g => `-g'${g}'`),
      ...excludes.map(g => `-g'!${g}'`),
    ];
    document.getElementById('rgPreview').textContent = rgParts.join(' ');
  }

  function escHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  /* ── Chip rendering ──────────────────────── */
  function renderChips() {
    renderChipRow('incChips', state.includeGlobs, 'inc', false);
    renderChipRow('excChips', state.excludeGlobs, 'exc', false);
  }

  function renderChipRow(containerId, globs, kind, _unused) {
    const container = document.getElementById(containerId);
    const customSet = new Set(kind === 'inc' ? state.customIncludeGlobs : state.customExcludeGlobs);
    container.innerHTML = '';
    for (const glob of globs) {
      const isCustom = customSet.has(glob);
      const chip = document.createElement('span');
      chip.className = `chip ${kind}${isCustom ? ' custom' : ''}`;
      chip.innerHTML = `${escHtml(glob)} <span class="chip-x" title="Remove">×</span>`;
      chip.querySelector('.chip-x').addEventListener('click', () => removeChip(glob, kind));
      container.appendChild(chip);
    }
  }

  function removeChip(glob, kind) {
    if (kind === 'inc') {
      state.includeGlobs = state.includeGlobs.filter(g => g !== glob);
      // Also remove from customIncludeGlobs if present.
      state.customIncludeGlobs = state.customIncludeGlobs.filter(g => g !== glob);
      syncTextareaFromState();
    } else {
      state.excludeGlobs = state.excludeGlobs.filter(g => g !== glob);
      state.customExcludeGlobs = state.customExcludeGlobs.filter(g => g !== glob);
      syncTextareaFromState();
    }
    // Reset any tree node that owns this pattern.
    resetTreeNodeForGlob(glob);
    renderAll();
    postState();
  }

  function syncTextareaFromState() {
    document.getElementById('customIncTA').value = joinTextarea(state.customIncludeGlobs);
    document.getElementById('customExcTA').value = joinTextarea(state.customExcludeGlobs);
  }

  /* ── Tree rendering ──────────────────────── */
  let treeNodes = []; // { id, label, incGlob, excGlob, kind:'folder'|'ext' }

  function buildTreeNode(label, kind) {
    const incGlob = kind === 'folder' ? `**/${label}/**` : `**/*.${label}`;
    const excGlob = kind === 'folder' ? `**/${label}/**` : `**/*.${label}`;
    return { id: `${kind}:${label}`, label, incGlob, excGlob, kind };
  }

  function getNodeState(node) {
    if (state.includeGlobs.includes(node.incGlob)) return 'inc';
    if (state.excludeGlobs.includes(node.excGlob)) return 'exc';
    return 'neutral';
  }

  function renderTree() {
    const container = document.getElementById('treeList');
    if (treeNodes.length === 0) {
      container.innerHTML = '<div class="empty-tree">No files found in workspace.</div>';
      return;
    }

    const folders = treeNodes.filter(n => n.kind === 'folder');
    const exts    = treeNodes.filter(n => n.kind === 'ext');

    let html = '';
    if (folders.length) {
      html += `<div class="tree-section-label">Folders</div>`;
      for (const n of folders) html += renderTreeRow(n);
    }
    if (exts.length) {
      html += `<div class="tree-section-label">Extensions</div>`;
      for (const n of exts) html += renderTreeRow(n);
    }
    container.innerHTML = html;

    // Wire up buttons.
    container.querySelectorAll('[data-node-id]').forEach(row => {
      row.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', () => {
          const nodeId = row.getAttribute('data-node-id');
          const action = btn.getAttribute('data-action');
          handleTristate(nodeId, action);
        });
      });
    });
  }

  function renderTreeRow(node) {
    const ns = getNodeState(node);
    return `
      <div class="tree-row" data-node-id="${escHtml(node.id)}">
        <span class="tree-label" title="${escHtml(node.incGlob)}">${escHtml(node.label)}</span>
        <div class="tristate">
          <button data-action="inc" class="${ns === 'inc' ? 'active-inc' : ''}" title="Include">+</button>
          <button data-action="neutral" class="" title="Neutral">○</button>
          <button data-action="exc" class="${ns === 'exc' ? 'active-exc' : ''}" title="Exclude">−</button>
        </div>
      </div>`;
  }

  function handleTristate(nodeId, action) {
    const node = treeNodes.find(n => n.id === nodeId);
    if (!node) return;

    // Remove from both arrays first.
    state.includeGlobs = state.includeGlobs.filter(g => g !== node.incGlob);
    state.excludeGlobs = state.excludeGlobs.filter(g => g !== node.excGlob);

    if (action === 'inc') {
      state.includeGlobs = dedupe([...state.includeGlobs, node.incGlob]);
    } else if (action === 'exc') {
      state.excludeGlobs = dedupe([...state.excludeGlobs, node.excGlob]);
    }
    // 'neutral' just removes — already handled above.

    renderAll();
    postState();
  }

  function resetTreeNodeForGlob(glob) {
    // Re-render tree so the button highlight is cleared.
    // (The state arrays were already updated before calling this.)
    renderTree();
  }

  /* ── Custom globs textareas ──────────────── */
  function onCustomIncInput() {
    const vals = parseTextarea(document.getElementById('customIncTA').value);
    // Remove old custom includes from includeGlobs, then add new ones.
    const prevCustom = new Set(state.customIncludeGlobs);
    state.includeGlobs = state.includeGlobs.filter(g => !prevCustom.has(g));
    state.customIncludeGlobs = vals;
    state.includeGlobs = dedupe([...state.includeGlobs, ...vals]);
    renderChips();
    renderPreview();
    postState();
  }

  function onCustomExcInput() {
    const vals = parseTextarea(document.getElementById('customExcTA').value);
    const prevCustom = new Set(state.customExcludeGlobs);
    state.excludeGlobs = state.excludeGlobs.filter(g => !prevCustom.has(g));
    state.customExcludeGlobs = vals;
    state.excludeGlobs = dedupe([...state.excludeGlobs, ...vals]);
    renderChips();
    renderPreview();
    postState();
  }

  document.getElementById('customIncTA').addEventListener('input', onCustomIncInput);
  document.getElementById('customExcTA').addEventListener('input', onCustomExcInput);

  /* ── Render all ──────────────────────────── */
  function renderAll() {
    renderTree();
    renderChips();
    renderPreview();
  }

  /* ── Load state from host ────────────────── */
  function applyLoadedState(data) {
    state.includeGlobs       = Array.isArray(data.includeGlobs)       ? data.includeGlobs       : [];
    state.excludeGlobs       = Array.isArray(data.excludeGlobs)       ? data.excludeGlobs       : [];
    state.customIncludeGlobs = Array.isArray(data.customIncludeGlobs) ? data.customIncludeGlobs : [];
    state.customExcludeGlobs = Array.isArray(data.customExcludeGlobs) ? data.customExcludeGlobs : [];

    document.getElementById('customIncTA').value = joinTextarea(state.customIncludeGlobs);
    document.getElementById('customExcTA').value = joinTextarea(state.customExcludeGlobs);
    renderAll();
  }

  /* ── Message handler ─────────────────────── */
  window.addEventListener('message', (event) => {
    const msg = event.data;
    switch (msg.type) {
      case 'treeData': {
        treeNodes = [
          ...(msg.folders || []).map(f => buildTreeNode(f, 'folder')),
          ...(msg.extensions || []).map(e => buildTreeNode(e, 'ext')),
        ];
        renderTree();
        break;
      }
      case 'loadState': {
        applyLoadedState(msg);
        break;
      }
      case 'testGlobsResult': {
        const btnTest = document.getElementById('btnTest');
        btnTest.disabled = false;
        btnTest.textContent = 'Test globs with ripgrep';

        // Clear any previous textarea error annotations.
        clearTextareaErrors();

        const banner  = document.getElementById('testBanner');
        const title   = document.getElementById('testBannerTitle');
        const body    = document.getElementById('testBannerBody');
        banner.style.display = 'block';

        if (msg.ok) {
          banner.className = 'test-banner success';
          title.textContent = `Ripgrep accepted these globs. ${msg.count} file(s) matched.`;
          if (Array.isArray(msg.sample) && msg.sample.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'sample-list';
            for (const p of msg.sample) {
              const li = document.createElement('li');
              li.textContent = p;
              ul.appendChild(li);
            }
            body.innerHTML = '';
            body.appendChild(ul);
          } else {
            body.innerHTML = '';
          }
        } else {
          banner.className = 'test-banner error';
          const errText = msg.error || 'Unknown error.';
          title.textContent = 'Ripgrep reported an error:';
          body.textContent = errText;
          // Try to highlight which custom textarea contains the offending pattern.
          annotateTextareaErrors(errText);
        }
        break;
      }
    }
  });

  /* ── Textarea error annotation ───────────── */
  function clearTextareaErrors() {
    document.getElementById('customIncTA').classList.remove('ta-error');
    document.getElementById('customExcTA').classList.remove('ta-error');
    const h1 = document.getElementById('customIncHint');
    const h2 = document.getElementById('customExcHint');
    h1.className = 'ta-error-hint'; h1.textContent = '';
    h2.className = 'ta-error-hint'; h2.textContent = '';
  }

  function annotateTextareaErrors(errText) {
    // Check if any custom glob we sent appears verbatim in the error message.
    let incHit = false, excHit = false;
    for (const g of state.customIncludeGlobs) {
      if (g && errText.includes(g)) { incHit = true; break; }
    }
    for (const g of state.customExcludeGlobs) {
      if (g && errText.includes(g)) { excHit = true; break; }
    }
    if (incHit) {
      document.getElementById('customIncTA').classList.add('ta-error');
      const h = document.getElementById('customIncHint');
      h.textContent = 'A pattern here may have caused the error.';
      h.className = 'ta-error-hint visible';
    }
    if (excHit) {
      document.getElementById('customExcTA').classList.add('ta-error');
      const h = document.getElementById('customExcHint');
      h.textContent = 'A pattern here may have caused the error.';
      h.className = 'ta-error-hint visible';
    }
  }

  /* ── Action buttons ──────────────────────── */
  document.getElementById('btnApply').addEventListener('click', () => {
    vscode.postMessage({ type: 'applyAndRerun', ...state });
  });

  document.getElementById('btnSave').addEventListener('click', () => {
    vscode.postMessage({ type: 'saveAsFilter', ...state });
  });

  document.getElementById('btnTest').addEventListener('click', () => {
    // Clear previous results and annotate.
    clearTextareaErrors();
    const banner = document.getElementById('testBanner');
    banner.style.display = 'none';
    banner.className = 'test-banner';
    document.getElementById('testBannerTitle').textContent = '';
    document.getElementById('testBannerBody').textContent = '';

    const btn = document.getElementById('btnTest');
    btn.disabled = true;
    btn.textContent = 'Testing\u2026';

    vscode.postMessage({ type: 'testGlobs', ...state });
  });

  /* ── Bootstrap ───────────────────────────── */
  vscode.postMessage({ type: 'requestTreeData' });

})();
</script>
</body>
</html>
