<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-sideBar-background);
            overflow: hidden;
        }

        /* ── Main toolbar strip ──────────────────────────────────────────── */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 8px;
            flex-wrap: wrap;
        }

        .toolbar-label {
            font-size: 0.72em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--vscode-descriptionForeground);
            margin-right: 6px;
            white-space: nowrap;
        }

        /* ── Individual toggle button ────────────────────────────────────── */
        .toggle-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 22px;
            border: 1px solid transparent;
            border-radius: 3px;
            background: none;
            cursor: pointer;
            color: var(--vscode-descriptionForeground);
            transition: background-color 0.12s, border-color 0.12s, color 0.12s;
            position: relative;
        }

        .toggle-btn:hover {
            background-color: var(--vscode-list-hoverBackground);
            border-color: var(--vscode-widget-border);
            color: var(--vscode-foreground);
        }

        .toggle-btn.active {
            background-color: var(--vscode-inputOption-activeBackground,
                              rgba(var(--vscode-button-background-rgb, 0, 120, 212), 0.2));
            border-color: var(--vscode-inputOption-activeBorder,
                           var(--vscode-button-background));
            color: var(--vscode-inputOption-activeForeground,
                        var(--vscode-button-background));
        }

        /* Icon glyphs using text — match VS Code's built-in search icons */
        .icon-case {
            font-size: 11px;
            font-weight: 700;
            font-family: var(--vscode-editor-font-family, monospace);
            letter-spacing: -1px;
        }

        .icon-word {
            font-size: 10px;
            font-weight: 700;
            font-family: var(--vscode-editor-font-family, monospace);
            border-bottom: 1.5px solid currentColor;
            line-height: 1;
            padding-bottom: 1px;
        }

        .icon-regex {
            font-size: 12px;
            font-family: var(--vscode-editor-font-family, monospace);
        }

        .icon-clear {
            font-size: 11px;
        }

        .icon-file-stats {
            font-size: 10px;
            font-family: var(--vscode-editor-font-family, monospace);
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* ── Action button (click only, no toggle state) ─────────────────── */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 22px;
            border: 1px solid transparent;
            border-radius: 3px;
            background: none;
            cursor: pointer;
            color: var(--vscode-descriptionForeground);
            transition: background-color 0.12s, border-color 0.12s, color 0.12s;
            position: relative;
        }

        .action-btn:hover {
            background-color: var(--vscode-list-hoverBackground);
            border-color: var(--vscode-widget-border);
            color: var(--vscode-foreground);
        }

        .action-btn:active {
            background-color: var(--vscode-inputOption-activeBackground);
        }

        /* ── Divider ─────────────────────────────────────────────────────── */
        .toolbar-sep {
            width: 1px;
            height: 16px;
            background-color: var(--vscode-panel-border);
            margin: 0 4px;
        }

        /* ── Labels row (below toolbar) ──────────────────────────────────── */
        .labels-row {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 0 8px 6px;
            flex-wrap: wrap;
        }

        .btn-label-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 28px;
        }

        .btn-label {
            font-size: 0.65em;
            color: var(--vscode-descriptionForeground);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            user-select: none;
        }

        /* ── Status strip ────────────────────────────────────────────────── */
        .active-summary {
            padding: 3px 8px 4px;
            font-size: 0.75em;
            color: var(--vscode-descriptionForeground);
            border-top: 1px solid var(--vscode-panel-border);
            min-height: 18px;
        }

        .active-summary.has-active {
            color: var(--vscode-inputValidation-infoForeground);
            background-color: var(--vscode-inputValidation-infoBackground);
        }

        /* ── Separator dots ──────────────────────────────────────────────── */
        .sep-label {
            margin: 0 3px;
            color: var(--vscode-panel-border);
        }

        /* ── Context-lines counter row ───────────────────────────────────── */
        .context-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px 6px;
            border-top: 1px solid var(--vscode-panel-border);
            flex-wrap: wrap;
        }

        .context-row-label {
            font-size: 0.72em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
            margin-right: 2px;
        }

        .context-counter {
            display: inline-flex;
            align-items: center;
            gap: 0;
            border: 1px solid var(--vscode-widget-border, var(--vscode-panel-border));
            border-radius: 3px;
            overflow: hidden;
        }

        .ctx-flag {
            font-size: 0.72em;
            font-weight: 700;
            font-family: var(--vscode-editor-font-family, monospace);
            color: var(--vscode-descriptionForeground);
            padding: 1px 4px 1px 5px;
            background: var(--vscode-input-background);
            border-right: 1px solid var(--vscode-widget-border, var(--vscode-panel-border));
            user-select: none;
            white-space: nowrap;
        }

        .ctx-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 20px;
            border: none;
            border-radius: 0;
            background: none;
            cursor: pointer;
            color: var(--vscode-foreground);
            font-size: 13px;
            line-height: 1;
            padding: 0;
        }

        .ctx-btn:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .ctx-btn:active {
            background-color: var(--vscode-inputOption-activeBackground);
        }

        .ctx-value {
            min-width: 22px;
            text-align: center;
            font-size: 0.78em;
            font-family: var(--vscode-editor-font-family, monospace);
            font-weight: 600;
            color: var(--vscode-foreground);
            background: var(--vscode-input-background);
            border-left: 1px solid var(--vscode-widget-border, var(--vscode-panel-border));
            border-right: 1px solid var(--vscode-widget-border, var(--vscode-panel-border));
            padding: 1px 2px;
            user-select: none;
            cursor: default;
        }

        .ctx-value.nonzero {
            color: var(--vscode-inputOption-activeForeground, var(--vscode-button-background));
            background-color: var(--vscode-inputOption-activeBackground, rgba(0,120,212,0.15));
        }
    </style>
</head>
<body>
    <div class="toolbar" id="toolbar">
        <!-- Buttons injected by JS based on mode -->
    </div>
    <div class="labels-row" id="labelsRow"></div>
    <div class="context-row" id="contextRow" style="display:none"></div>
    <div class="active-summary" id="activeSummary">No filters active</div>

    <script>
    try {
        const vscode = acquireVsCodeApi();

        // ── Configuration passed via body data attribute ──────────────────
        // The provider injects: data-mode="live" or data-mode="session"
        const mode = document.body.dataset.mode || 'live';

        // ── Button definitions ────────────────────────────────────────────
        const LIVE_BUTTONS = [
            {
                id: 'caseSensitive',
                title: 'Case Sensitive (Alt+C)',
                iconClass: 'icon-case',
                iconText: 'Aa',
                label: 'Case'
            },
            {
                id: 'wholeWord',
                title: 'Whole Word (Alt+W)',
                iconClass: 'icon-word',
                iconText: 'ab',
                label: 'Word'
            },
            {
                id: 'useRegex',
                title: 'Use Regular Expression (Alt+R)',
                iconClass: 'icon-regex',
                iconText: '.*',
                label: 'Regex'
            }
        ];

        // Action buttons only available in live mode
        const LIVE_ACTION_BUTTONS = [
            {
                id: 'fileStatsMode',
                title: 'File Statistics Search – ripgrep files-only (match count per file) with statistics',
                iconClass: 'icon-file-stats',
                iconText: 'F#',
                label: 'Files'
            }
        ];

        const SESSION_BUTTONS = [
            {
                id: 'caseSensitive',
                title: 'Case Sensitive',
                iconClass: 'icon-case',
                iconText: 'Aa',
                label: 'Case'
            },
            {
                id: 'wholeWord',
                title: 'Whole Word',
                iconClass: 'icon-word',
                iconText: 'ab',
                label: 'Word'
            }
        ];

        const buttons = mode === 'live' ? LIVE_BUTTONS : SESSION_BUTTONS;

        // ── State ─────────────────────────────────────────────────────────
        const restoreState = vscode.getState() || {};
        const state = {
            caseSensitive:      restoreState.caseSensitive      || false,
            wholeWord:          restoreState.wholeWord           || false,
            useRegex:           restoreState.useRegex            || false,
            fileStatsMode:      restoreState.fileStatsMode       || false,
            contextLines:       restoreState.contextLines        || 0,
            contextLinesBefore: restoreState.contextLinesBefore  ?? 10,
            contextLinesAfter:  restoreState.contextLinesAfter   ?? 10
        };

        // ── Build toolbar ─────────────────────────────────────────────────
        const toolbar   = document.getElementById('toolbar');
        const labelsRow = document.getElementById('labelsRow');

        buttons.forEach((btn, idx) => {
            // Button
            const el = document.createElement('button');
            el.className = 'toggle-btn' + (state[btn.id] ? ' active' : '');
            el.id = 'btn_' + btn.id;
            el.title = btn.title;
            el.setAttribute('aria-pressed', String(state[btn.id]));
            el.innerHTML = `<span class="${btn.iconClass}">${btn.iconText}</span>`;
            el.addEventListener('click', () => toggleOption(btn.id, el));
            toolbar.appendChild(el);

            // Label cell
            const cell = document.createElement('div');
            cell.className = 'btn-label-cell';
            cell.innerHTML = `<span class="btn-label">${btn.label}</span>`;
            labelsRow.appendChild(cell);
        });

        // ── Action buttons (Live mode only) — participate in toggle state ─
        if (mode === 'live' && LIVE_ACTION_BUTTONS.length > 0) {
            // Add a separator before action buttons
            const sep = document.createElement('div');
            sep.className = 'toolbar-sep';
            toolbar.appendChild(sep);
            // Matching spacer in labels row
            const sepSpacer = document.createElement('div');
            sepSpacer.style.width = '9px';
            sepSpacer.style.flexShrink = '0';
            labelsRow.appendChild(sepSpacer);

            LIVE_ACTION_BUTTONS.forEach(btn => {
                // Reuse toggle-btn so it looks like the other toggles
                const el = document.createElement('button');
                el.className = 'toggle-btn' + (state[btn.id] ? ' active' : '');
                el.id = 'btn_' + btn.id;
                el.title = btn.title;
                el.setAttribute('aria-pressed', String(!!state[btn.id]));
                el.innerHTML = `<span class="${btn.iconClass}">${btn.iconText}</span>`;
                // Reuse the existing toggleOption so state is persisted + shared
                el.addEventListener('click', () => toggleOption(btn.id, el));
                toolbar.appendChild(el);

                // Label cell
                const cell = document.createElement('div');
                cell.className = 'btn-label-cell';
                cell.innerHTML = `<span class="btn-label">${btn.label}</span>`;
                labelsRow.appendChild(cell);
            });
        }

        // ── Context-lines counters (Live mode only) ───────────────────────
        const CONTEXT_COUNTERS = [
            { id: 'contextLines',       flag: '-C', title: 'Context Lines: same number above and below each match (ripgrep -C)' },
            { id: 'contextLinesBefore', flag: '-B', title: 'Lines Before: context lines above each match (ripgrep -B)' },
            { id: 'contextLinesAfter',  flag: '-A', title: 'Lines After: context lines below each match (ripgrep -A)' }
        ];

        if (mode === 'live') {
            const contextRow = document.getElementById('contextRow');
            contextRow.style.display = 'flex';

            const rowLabel = document.createElement('span');
            rowLabel.className = 'context-row-label';
            rowLabel.textContent = 'Context';
            contextRow.appendChild(rowLabel);

            CONTEXT_COUNTERS.forEach(cfg => {
                const wrap = document.createElement('div');
                wrap.className = 'context-counter';
                wrap.title = cfg.title;

                const flagSpan = document.createElement('span');
                flagSpan.className = 'ctx-flag';
                flagSpan.textContent = cfg.flag;

                const decBtn = document.createElement('button');
                decBtn.className = 'ctx-btn';
                decBtn.textContent = '−';
                decBtn.setAttribute('aria-label', 'Decrease ' + cfg.flag);

                const valSpan = document.createElement('span');
                valSpan.className = 'ctx-value' + (state[cfg.id] > 0 ? ' nonzero' : '');
                valSpan.id = 'ctx_' + cfg.id;
                valSpan.textContent = state[cfg.id];

                const incBtn = document.createElement('button');
                incBtn.className = 'ctx-btn';
                incBtn.textContent = '+';
                incBtn.setAttribute('aria-label', 'Increase ' + cfg.flag);

                decBtn.addEventListener('click', () => adjustContext(cfg.id, valSpan, -1));
                incBtn.addEventListener('click', () => adjustContext(cfg.id, valSpan, +1));

                wrap.appendChild(flagSpan);
                wrap.appendChild(decBtn);
                wrap.appendChild(valSpan);
                wrap.appendChild(incBtn);
                contextRow.appendChild(wrap);
            });
        }

        // ── Toggle logic ──────────────────────────────────────────────────
        function toggleOption(id, el) {
            state[id] = !state[id];
            el.classList.toggle('active', state[id]);
            el.setAttribute('aria-pressed', String(state[id]));
            persistAndNotify();
        }

        // ── Context-counter logic ─────────────────────────────────────────
        function adjustContext(id, valSpan, delta) {
            const newVal = Math.max(0, Math.min(99, (state[id] || 0) + delta));
            state[id] = newVal;
            valSpan.textContent = newVal;
            valSpan.className = 'ctx-value' + (newVal > 0 ? ' nonzero' : '');
            persistAndNotify();
        }

        function syncContextSpan(id) {
            const span = document.getElementById('ctx_' + id);
            if (span) {
                const v = state[id] || 0;
                span.textContent = v;
                span.className = 'ctx-value' + (v > 0 ? ' nonzero' : '');
            }
        }

        function persistAndNotify() {
            vscode.setState(state);
            vscode.postMessage({ type: 'optionsChanged', mode, options: { ...state } });
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('activeSummary');
            const parts = [];
            if (state.caseSensitive) { parts.push('Case'); }
            if (state.wholeWord)     { parts.push('Word'); }
            if (state.useRegex)      { parts.push('.*'); }
            if (state.fileStatsMode) { parts.push('F#'); }
            if (state.contextLines  > 0) { parts.push('-C' + state.contextLines); }
            if (state.contextLinesBefore > 0) { parts.push('-B' + state.contextLinesBefore); }
            if (state.contextLinesAfter  > 0) { parts.push('-A' + state.contextLinesAfter); }

            if (parts.length === 0) {
                summary.textContent = 'No filters active';
                summary.className = 'active-summary';
            } else {
                summary.textContent = 'Active: ' + parts.join(' · ');
                summary.className = 'active-summary has-active';
            }
        }

        // ── Messages from extension ───────────────────────────────────────
        window.addEventListener('message', event => {
            const msg = event.data;
            if (msg.type === 'setOptions') {
                Object.assign(state, msg.options);
                // Update all toggle buttons (regular + action)
                [...buttons, ...(mode === 'live' ? LIVE_ACTION_BUTTONS : [])].forEach(btn => {
                    const el = document.getElementById('btn_' + btn.id);
                    if (el) {
                        el.classList.toggle('active', !!state[btn.id]);
                        el.setAttribute('aria-pressed', String(!!state[btn.id]));
                    }
                });
                // Sync context counter spans
                if (mode === 'live') {
                    syncContextSpan('contextLines');
                    syncContextSpan('contextLinesBefore');
                    syncContextSpan('contextLinesAfter');
                }
                vscode.setState(state);
                updateSummary();
            }
            if (msg.type === 'getOptions') {
                vscode.postMessage({ type: 'optionsChanged', mode, options: { ...state } });
            }
        });

        // Init summary and sync restored state back to the extension host.
        // Without this, options toggled before the first click are invisible
        // to the extension because _options defaults to all-false.
        updateSummary();
        vscode.postMessage({ type: 'optionsChanged', mode, options: { ...state } });

    } catch (err) {
        document.body.innerHTML = '<div style="color:red;padding:8px">Error: ' + err.message + '</div>';
    }
    </script>
</body>
</html>
