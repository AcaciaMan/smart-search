<?xml version="1.0" encoding="UTF-8" ?>
<!--
 Solr configuration for smart-search-results core
 Optimized for storing and searching ripgrep results
-->
<config>
  <luceneMatchVersion>9.0.0</luceneMatchVersion>

  <!-- Data directory -->
  <dataDir>${solr.data.dir:}</dataDir>

  <!-- Index configuration -->
  <directoryFactory name="DirectoryFactory" class="${solr.directoryFactory:solr.NRTCachingDirectoryFactory}"/>
  
  <codecFactory class="solr.SchemaCodecFactory"/>

  <!-- Index config -->
  <indexConfig>
    <lockType>${solr.lock.type:native}</lockType>
    <infoStream>true</infoStream>
    <ramBufferSizeMB>256</ramBufferSizeMB>
    <maxBufferedDocs>1000</maxBufferedDocs>
    <useCompoundFile>false</useCompoundFile>
    
    <mergePolicyFactory class="org.apache.solr.index.TieredMergePolicyFactory">
      <int name="maxMergeAtOnce">10</int>
      <int name="segmentsPerTier">10</int>
    </mergePolicyFactory>
    
    <mergeScheduler class="org.apache.lucene.index.ConcurrentMergeScheduler"/>
  </indexConfig>

  <!-- Update handler -->
  <updateHandler class="solr.DirectUpdateHandler2">
    <updateLog>
      <str name="dir">${solr.ulog.dir:}</str>
      <int name="numVersionBuckets">${solr.ulog.numVersionBuckets:65536}</int>
    </updateLog>
    
    <autoCommit>
      <maxTime>${solr.autoCommit.maxTime:15000}</maxTime>
      <openSearcher>false</openSearcher>
    </autoCommit>

    <autoSoftCommit>
      <maxTime>${solr.autoSoftCommit.maxTime:1000}</maxTime>
    </autoSoftCommit>
  </updateHandler>

  <!-- Query configuration -->
  <query>
    <maxBooleanClauses>${solr.max.booleanClauses:1024}</maxBooleanClauses>
    <filterCache class="solr.LRUCache" size="512" initialSize="512" autowarmCount="0"/>
    <queryResultCache class="solr.LRUCache" size="512" initialSize="512" autowarmCount="0"/>
    <documentCache class="solr.LRUCache" size="512" initialSize="512" autowarmCount="0"/>
    
    <enableLazyFieldLoading>true</enableLazyFieldLoading>
    <queryResultWindowSize>20</queryResultWindowSize>
    <queryResultMaxDocsCached>200</queryResultMaxDocsCached>
    
    <listener event="newSearcher" class="solr.QuerySenderListener">
      <arr name="queries">
        <lst><str name="q">*:*</str></lst>
      </arr>
    </listener>
    <listener event="firstSearcher" class="solr.QuerySenderListener">
      <arr name="queries">
        <lst><str name="q">*:*</str></lst>
      </arr>
    </listener>

    <useColdSearcher>false</useColdSearcher>
  </query>

  <!-- Request dispatcher -->
  <requestDispatcher>
    <requestParsers enableRemoteStreaming="true" multipartUploadLimitInKB="2048000" formdataUploadLimitInKB="2048"/>
    <httpCaching never304="true"/>
  </requestDispatcher>

<!-- Use default highlighting component for maximum compatibility -->

  <!-- Request handlers -->
  
  <!-- Standard request handler -->
<!-- Standard request handler with highlighting -->
<requestHandler name="/select" class="solr.SearchHandler">
  <lst name="defaults">
    <str name="echoParams">explicit</str>
    <int name="rows">10</int>
    <str name="df">content_all</str>
    
    <!-- Highlighting defaults — aligned with SolrQueryBuilder.buildSearchParams().
         The canonical highlighting field is display_content (type: text_display).
         Per-query params from the extension override these defaults. -->
    <str name="hl">false</str>
    <str name="hl.fl">display_content</str>
    <str name="hl.simple.pre">&lt;mark class="highlight"&gt;</str>
    <str name="hl.simple.post">&lt;/mark&gt;</str>
    <int name="hl.fragsize">300</int>
    <int name="hl.snippets">1</int>
    <str name="hl.mergeContiguous">true</str>
    <str name="hl.highlightMultiTerm">true</str>
    <str name="hl.usePhraseHighlighter">true</str>
    <int name="hl.maxAnalyzedChars">500000</int>
  </lst>
  
  <arr name="components">
    <str>query</str>
    <str>facet</str>
    <str>mlt</str>
    <str>highlight</str>
    <str>stats</str>
    <str>debug</str>
  </arr>
</requestHandler>

  <!-- Search for ripgrep results — primary handler used by IndexManager.
       SolrQueryBuilder.buildSearchParams() sends per-query hl params that override
       these defaults. The canonical highlighting field is display_content. -->
  <requestHandler name="/search" class="solr.SearchHandler">
    <lst name="defaults">
      <str name="defType">edismax</str>
      <str name="echoParams">explicit</str>
      <int name="rows">50</int>
      <str name="df">content_all</str>
      <str name="qf">match_text^5.0 full_line^3.0 context_before^1.5 context_after^1.5 file_name^2.0 ai_summary^2.0</str>
      <str name="pf">match_text^10.0 full_line^5.0</str>
      <str name="fl">*,score</str>
      <str name="sort">score desc, search_timestamp desc</str>
      <str name="hl">true</str>
      <str name="hl.fl">display_content</str>
      <str name="hl.simple.pre">&lt;mark class="highlight"&gt;</str>
      <str name="hl.simple.post">&lt;/mark&gt;</str>
      <int name="hl.fragsize">300</int>
      <int name="hl.snippets">1</int>
      <str name="hl.mergeContiguous">true</str>
      <str name="hl.highlightMultiTerm">true</str>
      <str name="hl.usePhraseHighlighter">true</str>
      <int name="hl.maxAnalyzedChars">500000</int>
      <str name="facet">true</str>
      <str name="facet.field">file_extension</str>
      <str name="facet.field">search_session_id</str>
      <str name="facet.field">file_name</str>
      <str name="facet.mincount">1</str>
    </lst>
  </requestHandler>

  <!-- Search within specific session -->
  <requestHandler name="/search-session" class="solr.SearchHandler">
    <lst name="defaults">
      <str name="defType">edismax</str>
      <str name="echoParams">explicit</str>
      <int name="rows">100</int>
      <str name="df">content_all</str>
      <str name="qf">match_text^5.0 full_line^3.0 context_before^1.5 context_after^1.5</str>
      <str name="fl">*,score</str>
      <str name="sort">file_path asc, line_number asc</str>
    </lst>
  </requestHandler>

  <!-- Update handlers -->
  <requestHandler name="/update" class="solr.UpdateRequestHandler"/>
  <requestHandler name="/update/json" class="solr.UpdateRequestHandler">
    <lst name="defaults">
      <str name="stream.contentType">application/json</str>
    </lst>
  </requestHandler>

  <!-- Admin handlers -->
  <requestHandler name="/admin/ping" class="solr.PingRequestHandler">
    <lst name="invariants">
      <str name="q">*:*</str>
    </lst>
    <lst name="defaults">
      <str name="echoParams">all</str>
    </lst>
  </requestHandler>

  <!-- Analysis handler for debugging -->
  <requestHandler name="/analysis/field" startup="lazy" class="solr.FieldAnalysisRequestHandler"/>
  <requestHandler name="/analysis/document" class="solr.DocumentAnalysisRequestHandler" startup="lazy"/>

  <!-- Terms component — used by SolrSessionManager.getSuggestions() for
       auto-complete suggestions via prefix matching on match_text. -->
  <searchComponent name="terms" class="solr.TermsComponent"/>

  <requestHandler name="/terms" class="solr.SearchHandler">
    <lst name="defaults">
      <bool name="terms">true</bool>
      <bool name="distrib">false</bool>
    </lst>
    <arr name="components">
      <str>terms</str>
    </arr>
  </requestHandler>

  <!-- Legacy XML update handler -->
  <requestHandler name="/update/xml" class="solr.UpdateRequestHandler" startup="lazy"/>
  
  <!-- CSV update handler -->
  <requestHandler name="/update/csv" class="solr.UpdateRequestHandler" startup="lazy">
    <lst name="defaults">
      <str name="stream.contentType">application/csv</str>
    </lst>
  </requestHandler>

</config>
